# Bonnes pratiques {.backgroundTitre}

## Cerise, un espace partag√©

Comme tout espace partag√© et mutualis√©, il convient d'√™tre √©conome en ressources sur Cerise.  

Le DEMESIS a principalement 2 m√©triques en t√™te :  

- **La consommation de m√©moire vive (RAM)** : utile pour stocker les donn√©es en cours de traitement dans les sessions R.  
- **La consommation de CPU (processeur)** : refl√®te l'intensit√© des calculs demand√©s par une session R.

## Gestion des ressources par les utilisateurs (1/2)

Voici quelques conseils pour limiter la consommation de m√©moire sous Cerise :  

- **D√©sactiver la sauvegarde automatique des √©l√©ments de session**  

![](img/sauv_RData.png){fig-align="center"}

## Gestion des ressources par les utilisateurs (2/2)

- **Nettoyer r√©guli√®rement sa m√©moire vive**  

Utiliser la fonction `gc()` pour lib√©rer la m√©moire occup√©e inutilement par votre session.  
Ou via l'interface de RStudio :  

![](img/liberer_memoire.png){fig-align="center"}

Voir [cette page d'utilitr](https://book.utilitr.org/01_R_Insee/Fiche_utiliser_ressources.html) pour en savoir plus.
    
- **Pour les donn√©es volumineuses, privil√©gier le format de fichier Parquet**  (voir plus loin)
  Voir [ici](https://ssm-agriculture.github.io/formation-R-perf-06-parquet/) pour en savoir plus et/ou vous inscrire aux annonces de formation du BQIS.

## Gestion des sessions (1/2)

- Quand vous vous connectez sur Cerise via l'adresse fournie - **si vous n'avez qu'une session d'ouverte** - Cerise vous place directement dedans (vous arrivez donc dans l'interface RStudio).

- **A partir de 2 sessions ouvertes**, lorsque vous vous connectez √† Cerise, vous allez arriver sur l'√©cran de gestion des sessions :  

![](img/home_sessions.png){fig-align="center"}

## Gestion des sessions (2/2)

- Dans la colonne de gauche de l'√©cran des sessions, vous trouverez vos sessions ouvertes.  
- Dans la colonne de droite de l'√©cran des sessions, vous trouvez les diff√©rents projets que vous r√©cemment utilis√©s.  


**Chaque session est ind√©pendante des autres.** Si vous avez lanc√© un long traitement dans une session, celle-ci est occup√©e et non-r√©active le temps du traitement, mais vous pouvez continuer √† travailler normalement dans les autres sessions.

::: callout-important
## √Ä retenir ! 

Il est important de veiller √† limiter votre nombre de sessions actives (maximum 5 !) au risque de ne plus pouvoir acc√©der √† Cerise par la suite.  

Au S2 2025, il est pr√©vu de limiter le nombre de sessions en parall√®le par utilisateur et de supprimer automatiquement les sessions inactives.
:::


## Chargement/T√©l√©chargement de fichiers Cerise (1/2)

- Pour **charger** vers Cerise des fichiers depuis votre poste en local :  

Cliquer sur le bouton "upload/t√©l√©charger" dans l'onglet "Files/Fichiers"  

![](img/charger_cerise.png){fig-align="center"}

- Pour **t√©l√©charger** depuis Cerise vers votre poste en local :  

Cliquer sur la roue crant√©e dans l'onglet "Files"

![](img/telecharger_cerise.png){fig-align="center"}

## Chargement/T√©l√©chargement de fichiers Cerise (2/2)

- Si vous souhaitez **charger** plusieurs fichiers en m√™me temps sous Cerise, faire un fichier ZIP.  
Son contenu sera ensuite automatiquement d√©zipp√© sous Cerise.  

::: callout-caution
## Pour information 

Les administrateurs de Cerise n'ont pas la possibilit√© de mettre en place un filtre sur le type de fichiers qui sont charg√©s sur Cerise => veillez √† ne pas t√©l√©charger n'importe quel type de fichier (ex√©cutables par exemple).
:::

<br>  

- Si vous souhaitez **t√©l√©charger** plusieurs fichiers depuis Cerise, RStudio Server va automatiquement les joindre dans un fichier ZIP sur votre poste en local.  

## Restauration des fichiers

- Offre de sauvegarde du centre de service (CDS)  
    - Sauvegarde compl√®te le vendredi soir  
    - Sauvegarde diff√©rentielle les autres jours (Lun./Mar./Mer./Jeu. soir)  
    
- Les sauvegardes diff√©rentielles ne sont conserv√©es que **15 jours calendaires**  

- Des demandes de restauration d√©licates voire impossibles :  
    - D√©lais de remont√©e du besoin m√©tier  
    - D√©lais de prise en charge du centre de service
    
## Versionner votre code

Une bonne pratique pour limiter les demandes de restauration de fichiers est de **versionner avec Git** vos scripts et programmes R.  

**Git permet :**  

- D'obtenir de la tra√ßabilit√©  
- De travailler collectivement  
- De faire des revues de code  
- De revenir en arri√®re dans le temps...  

Un module de formation est disponible [√† cette adresse](https://ssm-agriculture.github.io/formation-git/), n'h√©sitez pas √† vous y inscrire !  

Pour ceux d'entre vous d√©j√† form√©s et qui souhaitent configurer Cerise avec Gitlab, suivre [ce tutoriel](https://github.com/user-attachments/files/19664705/Tutoriel.-.Configuration.d.une.connexion.Cerise_Gitlab.pdf).

## Utilisation du mode projet

Il est recommand√© d'utiliser **le mode projet** le plus souvent possible.  
Plusieurs avantages :   

- Organisation claire  
- Gestion des chemins d'acc√®s portable  
- Reproductibilit√©  
- Isolation des environnements (avec {renv})  
- Int√©gration avec Git ...


## Comparatif des formats de fichier de donn√©es

| Format | Taille du fichier | Utilisation m√©moire | Vitesse √©criture | Vitesse lecture |
|--------|-------------------|---------------------|------------------|-----------------|
| Parquet | ‚úÖ Faible (colonnes compress√©es, binaire) | ‚úÖ Faible (lecture par lot, colonnes cibl√©es) | ‚ö†Ô∏è √âcriture plus lente (compression + formatage) | üöÄ Tr√®s rapide |
| RDS | ‚úÖ Moyenne √† faible (compress√©, un seul objet) | ‚ö†Ô∏è Mod√©r√©e (lecture directe d'un objet) | ‚úÖ Rapide (compresse par d√©faut) | ‚úÖ Rapide (pour un seul objet) |
| RData | ‚ö†Ô∏è Moyenne √† faible (compress√©, contient plusieurs objets) | ‚ùå Moyenne √† √©lev√©e (charge tous les objets en m√©moire) | ‚úÖ Relativement rapide | ‚ö†Ô∏è Lecture rapide mais tout est charg√© (peu flexible) |
| CSV | ‚ùå Tr√®s grande (non compress√©, texte brut) | ‚ùå √âlev√©e (tout doit √™tre pars√©, conversion de type) | ‚úÖ Rapide √† √©crire, peu co√ªteux | üê¢ Lent, tr√®s co√ªteux en ressources |

Format interm√©diaire d'application (le plus rapide) : {fst}

## R√©sum√© des propri√©t√©s des diff√©rents formats

- CSV  
    Tr√®s facile √† manipuler manuellement, mais inefficace pour les gros volumes.  
    Pas de support natif pour les types de donn√©es (dates, facteurs).  
    Import/Export tr√®s lents en R pour de grands volumes.  
- Parquet  
    Requiert le package {arrow} en R.  
    Lecture partielle possible (par colonne ou ligne).  
    Excellent pour la mutualisation, le cloud, ou les flux inter-langages (Python, Spark‚Ä¶).  
- RData  
    Sauvegarde plusieurs objets, utile pour des environnements complexes.  
    Inadapt√© pour charger s√©lectivement un seul objet dans un gros fichier.  
- RDS  
   Format natif optimis√© pour un seul objet R.  
   Tr√®s bon compromis pour la persistance simple et performante en R pur.  

## Recommandations selon le contexte

| Cas d'usage | Format conseill√© |
|-------------|------------------|
| Volume important, usage mutualis√©, scalable | Parquet |
| Persistance R native, mono-objet | RDS |
| Sauvegarde compl√®te d'environnement | RData |
| √âchange simple, manuel, petit volume | CSV |


Archive √† long terme : CSV avec son dictionnaire des donn√©es

## Mise √† disposition d'applications Shiny

Pour certains cas m√©tiers sp√©cifiques et sous certaines contraintes (s√©curit√©/performance/maintenabilit√©...), il est possible de d√©ployer sur internet des applications web (R/Shiny) sur [shinyapps.io](https://shinyapps.io/).  

Des pr√©cautions s'imposent et doivent √™tre prises en compte en amont des d√©veloppements par les bureaux m√©tiers et/ou les SRISE.

Nous invitons les √©quipes concern√©s de se rapprocher du BQIS pour plus d'informations.
